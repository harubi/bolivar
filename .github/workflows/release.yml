name: Release

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or commit to release from'
        required: false
        default: master
        type: string

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  release:
    name: Semantic release
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0
          persist-credentials: true
          submodules: true
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: nightly
      - name: Setup Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: 22
      - name: Authenticate with crates.io
        uses: rust-lang/crates-io-auth-action@v1.0.3
        id: crates-auth
      - name: Install semantic-release
        run: npm ci
      - name: Run semantic-release
        id: semantic
        run: npx semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ steps.crates-auth.outputs.token }}

  build-native-libs:
    name: Build native lib (${{ matrix.classifier }})
    needs: release
    if: needs.release.outputs.new_release_published == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            target: x86_64-unknown-linux-gnu
            classifier: linux-x86-64
            lib_name: libbolivar_uniffi.so
          - os: ubuntu-24.04
            target: aarch64-unknown-linux-gnu
            classifier: linux-aarch64
            lib_name: libbolivar_uniffi.so
            cross: true
          - os: macos-15-intel
            target: x86_64-apple-darwin
            classifier: macos-x86-64
            lib_name: libbolivar_uniffi.dylib
          - os: macos-latest
            target: aarch64-apple-darwin
            classifier: macos-aarch64
            lib_name: libbolivar_uniffi.dylib
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            classifier: windows-x86-64
            lib_name: bolivar_uniffi.dll
          - os: windows-11-arm
            target: aarch64-pc-windows-msvc
            classifier: windows-aarch64
            lib_name: bolivar_uniffi.dll
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2
        with:
          ref: v${{ needs.release.outputs.new_release_version }}
          submodules: true
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: nightly
          targets: ${{ matrix.target }}
      - name: Install cross
        if: matrix.cross
        run: cargo install cross
      - name: Build UniFFI cdylib
        run: ${{ matrix.cross && 'cross' || 'cargo' }} build -p bolivar-uniffi --release --target ${{ matrix.target }}
      - name: Upload native library
        uses: actions/upload-artifact@v6.0.0
        with:
          name: native-${{ matrix.classifier }}
          path: target/${{ matrix.target }}/release/${{ matrix.lib_name }}

  publish-maven:
    name: Publish to Maven Central
    needs: [release, build-native-libs]
    if: needs.release.outputs.new_release_published == 'true'
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2
        with:
          ref: v${{ needs.release.outputs.new_release_version }}
          submodules: true
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: nightly
      - name: Setup Java
        uses: actions/setup-java@v5.2.0
        with:
          distribution: temurin
          java-version: 21
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5.0.1
      - name: Download native libraries
        uses: actions/download-artifact@v7.0.0
        with:
          pattern: native-*
          path: crates/uniffi/jvm/natives/
          merge-multiple: false
      - name: Organize native libraries
        run: |
          cd crates/uniffi/jvm/natives
          for dir in native-*; do
            classifier="${dir#native-}"
            mv "$dir" "$classifier"
          done
      - name: Verify all native libraries present
        run: |
          cd crates/uniffi/jvm/natives
          for classifier in linux-x86-64 linux-aarch64 macos-x86-64 macos-aarch64 windows-x86-64 windows-aarch64; do
            [ -d "$classifier" ] || { echo "Missing $classifier"; exit 1; }
          done
      - name: Generate Kotlin bindings
        run: cargo build -p bolivar-uniffi && cargo run -p bolivar-uniffi --bin uniffi-bindgen generate --library target/debug/libbolivar_uniffi.so --language kotlin --out-dir crates/uniffi/kotlin
      - name: Publish to Maven Central
        run: ./scripts/publish-maven.sh
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_SIGNING_PASSWORD }}

  trigger-pypi:
    name: Trigger PyPI publish
    needs: release
    if: needs.release.outputs.new_release_published == 'true'
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Dispatch CI workflow
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'CI.yml',
              ref: 'v${{ needs.release.outputs.new_release_version }}',
              inputs: { ref: 'v${{ needs.release.outputs.new_release_version }}' },
            });
