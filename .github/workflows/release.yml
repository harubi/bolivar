name: Release

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or commit to release from'
        required: false
        default: master
        type: string

concurrency:
  group: release
  cancel-in-progress: false

permissions:
  contents: read

env:
  CARGO_INCREMENTAL: "0"

jobs:
  semantic-release:
    name: Semantic release
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0
          persist-credentials: true
      - name: Setup Rust
        run: rustup show active-toolchain
      - uses: Swatinem/rust-cache@v2
      - name: Setup Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: 22
          cache: npm
      - name: Authenticate with crates.io
        uses: rust-lang/crates-io-auth-action@v1.0.3
        id: crates-auth
      - name: Install semantic-release
        run: npm ci
      - name: Run semantic-release
        id: semantic
        run: npx semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ steps.crates-auth.outputs.token }}
          GIT_AUTHOR_NAME: "github-actions[bot]"
          GIT_AUTHOR_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"
          GIT_COMMITTER_NAME: "github-actions[bot]"
          GIT_COMMITTER_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"

  build-wheels-linux:
    name: Build wheels (linux-${{ matrix.target }})
    needs: semantic-release
    if: needs.semantic-release.outputs.new_release_published == 'true'
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        target: [x86_64, x86, aarch64, armv7, s390x, ppc64le]
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          ref: v${{ needs.semantic-release.outputs.new_release_version }}
      - name: Build wheels
        uses: PyO3/maturin-action@v1.50.0
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --find-interpreter
          sccache: true
          manylinux: auto
      - name: Upload wheels
        uses: actions/upload-artifact@v6.0.0
        with:
          name: wheels-linux-${{ matrix.target }}
          path: dist

  build-wheels-musllinux:
    name: Build wheels (musllinux-${{ matrix.target }})
    needs: semantic-release
    if: needs.semantic-release.outputs.new_release_published == 'true'
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        target: [x86_64, x86, aarch64, armv7]
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          ref: v${{ needs.semantic-release.outputs.new_release_version }}
      - name: Build wheels
        uses: PyO3/maturin-action@v1.50.0
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --find-interpreter
          sccache: true
          manylinux: musllinux_1_2
      - name: Upload wheels
        uses: actions/upload-artifact@v6.0.0
        with:
          name: wheels-musllinux-${{ matrix.target }}
          path: dist

  build-wheels-windows:
    name: Build wheels (windows-${{ matrix.platform.target }})
    needs: semantic-release
    if: needs.semantic-release.outputs.new_release_published == 'true'
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - runner: windows-latest
            target: x64
          - runner: windows-latest
            target: x86
          - runner: windows-11-arm
            target: aarch64
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          ref: v${{ needs.semantic-release.outputs.new_release_version }}
      - uses: actions/setup-python@v6.2.0
        with:
          python-version: '3.13'
          architecture: ${{ matrix.platform.target == 'aarch64' && 'arm64' || matrix.platform.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.platform.target }}
      - name: Build wheels
        uses: PyO3/maturin-action@v1.50.0
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist --find-interpreter
          sccache: true
      - name: Upload wheels
        uses: actions/upload-artifact@v6.0.0
        with:
          name: wheels-windows-${{ matrix.platform.target }}
          path: dist

  build-wheels-macos:
    name: Build wheels (macos-${{ matrix.platform.target }})
    needs: semantic-release
    if: needs.semantic-release.outputs.new_release_published == 'true'
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - runner: macos-15-intel
            target: x86_64
          - runner: macos-latest
            target: aarch64
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          ref: v${{ needs.semantic-release.outputs.new_release_version }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.platform.target }}
      - name: Build wheels
        uses: PyO3/maturin-action@v1.50.0
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist --find-interpreter
          sccache: true
      - name: Upload wheels
        uses: actions/upload-artifact@v6.0.0
        with:
          name: wheels-macos-${{ matrix.platform.target }}
          path: dist

  build-sdist:
    name: Build sdist
    needs: semantic-release
    if: needs.semantic-release.outputs.new_release_published == 'true'
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          ref: v${{ needs.semantic-release.outputs.new_release_version }}
      - name: Build sdist
        uses: PyO3/maturin-action@v1.50.0
        with:
          command: sdist
          args: --out dist
      - name: Upload sdist
        uses: actions/upload-artifact@v6.0.0
        with:
          name: wheels-sdist
          path: dist

  build-native-libs:
    name: Build native lib (${{ matrix.classifier }})
    needs: semantic-release
    if: needs.semantic-release.outputs.new_release_published == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            target: x86_64-unknown-linux-gnu
            classifier: linux-x86-64
            lib_name: libbolivar_uniffi.so
          - os: ubuntu-24.04
            target: aarch64-unknown-linux-gnu
            classifier: linux-aarch64
            lib_name: libbolivar_uniffi.so
            cross: true
          - os: macos-15-intel
            target: x86_64-apple-darwin
            classifier: macos-x86-64
            lib_name: libbolivar_uniffi.dylib
          - os: macos-latest
            target: aarch64-apple-darwin
            classifier: macos-aarch64
            lib_name: libbolivar_uniffi.dylib
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            classifier: windows-x86-64
            lib_name: bolivar_uniffi.dll
          - os: windows-11-arm
            target: aarch64-pc-windows-msvc
            classifier: windows-aarch64
            lib_name: bolivar_uniffi.dll
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2
        with:
          ref: v${{ needs.semantic-release.outputs.new_release_version }}
      - name: Setup Rust
        run: |
          rustup show active-toolchain
          rustup target add ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}
      - name: Install cross
        if: matrix.cross
        uses: taiki-e/install-action@v2
        with:
          tool: cross
      - name: Build UniFFI cdylib
        run: ${{ matrix.cross && 'cross' || 'cargo' }} build -p bolivar-uniffi --release --target ${{ matrix.target }} --locked
      - name: Upload native library
        uses: actions/upload-artifact@v6.0.0
        with:
          name: native-${{ matrix.classifier }}
          path: target/${{ matrix.target }}/release/${{ matrix.lib_name }}
      - name: Build uniffi-bindgen
        if: matrix.target == 'x86_64-unknown-linux-gnu'
        run: cargo build -p bolivar-uniffi --bin uniffi-bindgen --release --target ${{ matrix.target }} --locked
      - name: Upload uniffi-bindgen
        if: matrix.target == 'x86_64-unknown-linux-gnu'
        uses: actions/upload-artifact@v6.0.0
        with:
          name: uniffi-bindgen-tool
          path: target/${{ matrix.target }}/release/uniffi-bindgen

  publish-pypi:
    name: Publish to PyPI
    needs: [semantic-release, build-wheels-linux, build-wheels-musllinux, build-wheels-windows, build-wheels-macos, build-sdist]
    runs-on: ubuntu-24.04
    permissions:
      id-token: write
      contents: write
      attestations: write
    environment:
      name: pypi
      url: https://pypi.org/p/bolivar
    steps:
      - name: Download all wheel artifacts
        uses: actions/download-artifact@v7.0.0
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true
      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v3.2.0
        with:
          subject-path: 'dist/*'
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/

  publish-maven:
    name: Publish to Maven Central
    needs: [semantic-release, build-native-libs]
    if: needs.semantic-release.outputs.new_release_published == 'true'
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2
        with:
          ref: v${{ needs.semantic-release.outputs.new_release_version }}
      - name: Setup Java
        uses: actions/setup-java@v5.2.0
        with:
          distribution: temurin
          java-version: 21
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5.0.1
      - name: Download native libraries
        uses: actions/download-artifact@v7.0.0
        with:
          pattern: native-*
          path: crates/uniffi/jvm/natives/
          merge-multiple: false
      - name: Organize native libraries
        run: |
          cd crates/uniffi/jvm/natives
          for dir in native-*; do
            classifier="${dir#native-}"
            mv "$dir" "$classifier"
          done
      - name: Verify all native libraries present
        run: |
          cd crates/uniffi/jvm/natives
          for classifier in linux-x86-64 linux-aarch64 macos-x86-64 macos-aarch64 windows-x86-64 windows-aarch64; do
            [ -d "$classifier" ] || { echo "Missing $classifier"; exit 1; }
          done
      - name: Download uniffi-bindgen
        uses: actions/download-artifact@v7.0.0
        with:
          name: uniffi-bindgen-tool
          path: .
      - name: Generate Kotlin bindings
        run: |
          chmod +x uniffi-bindgen
          ./uniffi-bindgen generate --library crates/uniffi/jvm/natives/linux-x86-64/libbolivar_uniffi.so --language kotlin --out-dir crates/uniffi/kotlin
      - name: Publish to Maven Central
        run: ./scripts/publish-maven.sh
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_SIGNING_PASSWORD }}
