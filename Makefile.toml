# cargo-make task definitions
# Install: cargo install cargo-make
# Run: cargo make <task>

[config]
default_to_workspace = false
skip_core_tasks = true

# ============================================================================
# Python
# ============================================================================

[tasks.build-py]
category = "Python"
description = "Build Python extension (development)"
command = "uv"
args = ["run", "maturin", "develop"]

[tasks.build-py-release]
category = "Python"
description = "Build Python wheels (release)"
command = "uv"
args = ["run", "maturin", "build", "--release"]

[tasks.test-py]
category = "Python"
description = "Run Python tests"
command = "uv"
args = ["run", "pytest", "tests/", "-v"]
dependencies = ["build-py"]

[tasks.test-cov]
category = "Python"
description = "Run Python tests with coverage"
command = "uv"
args = ["run", "pytest", "tests/", "-v", "--cov=bolivar", "--cov-report=term-missing"]
dependencies = ["build-py"]

# ============================================================================
# Rust
# ============================================================================

[tasks.build]
category = "Rust"
description = "Build all crates (debug)"
command = "cargo"
args = ["build"]

[tasks.build-release]
category = "Rust"
description = "Build all crates (release)"
command = "cargo"
args = ["build", "--release"]

[tasks.build-uniffi]
category = "Rust"
description = "Build UniFFI shared library (release)"
command = "cargo"
args = ["build", "-p", "bolivar-uniffi", "--release"]

[tasks.gen-kotlin]
category = "Rust"
description = "Generate Kotlin bindings from UniFFI UDL and release library"
script = '''
set -euo pipefail

case "$(uname -s)" in
  Darwin) lib_path="target/release/libbolivar_uniffi.dylib" ;;
  Linux) lib_path="target/release/libbolivar_uniffi.so" ;;
  MINGW*|MSYS*|CYGWIN*) lib_path="target/release/bolivar_uniffi.dll" ;;
  *) echo "Unsupported platform: $(uname -s)" >&2; exit 1 ;;
esac

if [ ! -f "$lib_path" ]; then
  echo "Missing UniFFI native library at $lib_path. Run cargo make build-uniffi first." >&2
  exit 1
fi

mkdir -p crates/uniffi/kotlin
find crates/uniffi/kotlin -mindepth 1 -maxdepth 1 -exec rm -rf {} +

cargo run -p bolivar-uniffi --bin uniffi-bindgen -- \
  generate \
  --library "$lib_path" \
  --language kotlin \
  --out-dir crates/uniffi/kotlin \
  --no-format
'''
dependencies = ["build-uniffi"]

[tasks.test]
category = "Rust"
description = "Run all Rust tests"
command = "cargo"
args = ["test"]

[tasks.test-layout]
category = "Rust"
description = "Run layout tests only"
command = "cargo"
args = ["test", "-p", "bolivar-core", "--test", "layout_test"]

[tasks.bench]
category = "Rust"
description = "Run all benchmarks"
command = "cargo"
args = ["bench", "-p", "bolivar-core"]

[tasks.bench-quick]
category = "Rust"
description = "Run quick benchmarks"
command = "cargo"
args = ["bench", "-p", "bolivar-core"]
env = { BOLIVAR_BENCH_TIER = "quick" }

[tasks.bench-full]
category = "Rust"
description = "Run full benchmarks"
command = "cargo"
args = ["bench", "-p", "bolivar-core"]
env = { BOLIVAR_BENCH_TIER = "full" }

[tasks.bench-save]
category = "Rust"
description = "Run benchmarks and save baseline"
command = "cargo"
args = ["bench", "-p", "bolivar-core", "--", "--save-baseline", "main"]

[tasks.bench-py]
category = "Python"
description = "Run Python benchmarks"
command = "uv"
args = ["run", "--extra", "bench", "pytest", "benchmarks/python", "-v", "--benchmark-only"]

[tasks.clippy]
category = "Rust"
description = "Run clippy lints"
command = "cargo"
args = ["clippy", "--all-targets", "--", "-D", "warnings"]

[tasks.fmt]
category = "Rust"
description = "Format code"
command = "cargo"
args = ["fmt"]

[tasks.fmt-check]
category = "Rust"
description = "Check code formatting"
command = "cargo"
args = ["fmt", "--check"]

[tasks.docs]
category = "Rust"
description = "Build documentation"
command = "cargo"
args = ["doc", "--no-deps"]

[tasks.docs-open]
category = "Rust"
description = "Build and open documentation"
command = "cargo"
args = ["doc", "--no-deps", "--open"]

# ============================================================================
# Workflow
# ============================================================================

[tasks.test-all]
category = "Workflow"
description = "Run all tests (Rust + Python)"
dependencies = ["test", "test-py"]

[tasks.lint]
category = "Workflow"
description = "Run all lints (format check + clippy)"
dependencies = ["fmt-check", "clippy"]

[tasks.dev]
category = "Workflow"
description = "Quick development check (build + test + clippy)"
dependencies = ["build", "test", "clippy"]

[tasks.ci]
category = "Workflow"
description = "Full CI pipeline (format + lint + all tests)"
dependencies = ["fmt-check", "clippy", "test", "test-py"]

# ============================================================================
# Cleanup
# ============================================================================

[tasks.clean]
category = "Cleanup"
description = "Clean all build artifacts (Rust + Python)"
script = '''
cargo clean
rm -rf target/wheels
rm -rf .pytest_cache
rm -rf .coverage
find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
echo "Cleaned all build artifacts"
'''

# ============================================================================
# Publishing
# ============================================================================

[tasks.publish-crates]
category = "Publishing"
description = "Publish Rust crates to crates.io"
script = '''
cargo publish -p bolivar-core
cargo publish -p bolivar-cli
'''

[tasks.publish-python]
category = "Publishing"
description = "Publish Python package to PyPI"
command = "uv"
args = ["run", "maturin", "publish"]

[tasks.publish-all]
category = "Publishing"
description = "Publish everything (crates + Python)"
dependencies = ["publish-crates", "publish-python"]

# ============================================================================
# CLI
# ============================================================================

[tasks.pdf2txt]
category = "CLI"
description = "Run pdf2txt CLI (pass args after --)"
script = "cargo run --bin pdf2txt -- ${@}"

[tasks.dumppdf]
category = "CLI"
description = "Run dumppdf CLI (pass args after --)"
script = "cargo run --bin dumppdf -- ${@}"

[tasks.test-miner]
category = "CLI"
description = "Run pdfminer.six CLI (pass args after --)"
script = "PYTHONPATH=crates/python/python:references/pdfminer.six uv run --with pytest --with pytest-cov --with pandas -m pytest references/pdfminer.six/"

[tasks.test-plumber]
category = "CLI"
description = "Run pdfminer.six CLI (pass args after --)"
script = "PYTHONPATH=crates/python/python:references/pdfplumber uv run --with pytest --with pytest-cov --with pandas -m pytest references/pdfplumber/"


[tasks.test-parity]
category = "Workflow"
description = "Run Rust + pdfminer.six + pdfplumber parity gate"
command = "bash"
args = ["-lc", """
  PYTHONPATH=crates/python/python:references/pdfminer.six uv run --with pytest --with pytest-cov --with pandas -m pytest references/pdfminer.six/ && \
  PYTHONPATH=crates/python/python:references/pdfplumber uv run --with pytest --with pytest-cov --with pandas -m pytest references/pdfplumber/
"""]
